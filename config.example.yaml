# OmniTAK Configuration Example
# Copy this file to config/config.yaml and customize for your environment

application:
  # Maximum concurrent connections to TAK servers
  max_connections: 100

  # Number of worker threads for message processing
  worker_threads: 4

# TAK Server Connections
servers:
  # Example: Official TAK Server with TLS 1.2 and client certificates
  - id: tak-server-production
    address: "takserver.example.com:8089"
    protocol: tls
    auto_reconnect: true
    reconnect_delay_ms: 5000
    tls:
      # IMPORTANT: Use traditional RSA format keys (see README.md)
      cert_path: "/path/to/certs/omnitak.pem"
      key_path: "/path/to/certs/omnitak-rsa.key"  # Must be traditional RSA format!
      ca_path: "/path/to/certs/ca.pem"
      # Set to false if using self-signed certificates in testing
      validate_certs: true

  # Example: TAKy server with basic TCP
  - id: taky-development
    address: "192.168.1.100:8087"
    protocol: tcp
    auto_reconnect: true

  # Example: UDP multicast
  - id: tactical-multicast
    address: "239.2.3.1:6969"
    protocol: multicast
    multicast_ttl: 5

# Message Filtering Rules
filters:
  # Mode: whitelist (only allow specified) or blacklist (block specified)
  mode: whitelist

  rules:
    # Allow friendly forces only
    - id: friendly-only
      type: affiliation
      allow: [friend, assumedfriend]
      destinations: [tak-server-production]

    # Filter by geographic bounds
    - id: operation-area
      type: geographic
      bounds:
        min_lat: 34.0
        max_lat: 35.0
        min_lon: -119.0
        max_lon: -118.0
      destinations: [taky-development]

    # Filter by team/group
    - id: team-alpha
      type: team
      teams: ["Alpha", "Bravo"]
      destinations: [tak-server-production]

# REST API Configuration
api:
  # Bind address for the API server
  bind_addr: "127.0.0.1:9443"

  # Enable TLS for the API (recommended for production)
  enable_tls: false

  # API TLS certificates (if enable_tls is true)
  # tls_cert_path: "/path/to/api-cert.pem"
  # tls_key_path: "/path/to/api-key.pem"

  # JWT token expiration (seconds)
  jwt_expiration: 86400  # 24 hours

  # Rate limiting (requests per second)
  rate_limit_rps: 100

  # Enable Swagger UI at /api-docs.html
  enable_swagger: true

  # Enable static file serving at /static
  enable_static_files: true

# Authentication
auth:
  # Default admin credentials (CHANGE THESE!)
  admin_user: "admin"
  admin_password: "changeme"  # Use environment variable OMNITAK_ADMIN_PASSWORD instead

# Logging
logging:
  # Log level: trace, debug, info, warn, error
  level: "info"

  # Output format: text or json
  format: "text"

  # Log to file (optional)
  # file: "/var/log/omnitak/omnitak.log"

# Metrics (Prometheus-compatible)
metrics:
  enabled: true
  # Endpoint: /api/v1/metrics

# Performance Tuning
performance:
  # Message buffer size per connection
  buffer_size: 8192

  # Maximum message size (bytes)
  max_message_size: 1048576  # 1 MB

  # Connection timeout (seconds)
  connection_timeout: 30

  # Keep-alive interval (seconds)
  keepalive_interval: 60

# Security
security:
  # Enable audit logging
  audit_logging: true

  # Allowed CORS origins (for API)
  cors_origins:
    - "http://localhost:3000"
    - "https://your-dashboard.example.com"

# Plugin System Configuration
plugins:
  # Directory containing plugin WASM files
  plugin_dir: "./plugins"

  # Enable hot-reload (development only - automatic reload when plugin files change)
  hot_reload: false

  # Resource limits for plugin execution
  resource_limits:
    # Maximum execution time per plugin call (milliseconds)
    max_execution_time_ms: 10000  # 10 seconds

    # Maximum memory per plugin instance (bytes)
    max_memory_bytes: 52428800  # 50 MB

    # Maximum number of concurrent plugin executions
    max_concurrent_executions: 100

  # Sandbox security policy - controls what plugins can access
  sandbox_policy:
    # Network access (required for source/transformer plugins that fetch data)
    allow_network: false

    # Filesystem read access (for plugins that need to read data files)
    allow_filesystem_read: false

    # Filesystem write access (for plugins that need to write logs/cache)
    allow_filesystem_write: false

    # Environment variable access
    allow_env_vars: false

    # Specific filesystem paths that are accessible (if filesystem access enabled)
    allowed_paths: []

  # Filter plugins - process and filter TAK messages
  filters:
    # Example: Geographic boundary filter
    - id: geofence-filter
      path: "geofence_filter.wasm"  # Relative to plugin_dir or absolute path
      enabled: true
      config:
        description: "Filter messages outside operational area"
        min_lat: 35.1
        max_lat: 35.3
        min_lon: -79.1
        max_lon: -78.9

    # Example: Affiliation-based filter
    - id: affiliation-filter
      path: "affiliation_filter.wasm"
      enabled: true
      config:
        description: "Only allow friendly forces"
        allowed_affiliations: ["friend", "assumed_friend", "neutral"]
        block_hostile: true

    # Example: Message type filter
    - id: type-filter
      path: "type_filter.wasm"
      enabled: false
      config:
        description: "Filter by CoT event type"
        allowed_types: ["a-f-G", "a-f-A", "a-h-G"]
        block_types: ["a-h-A"]

  # Transformer plugins - transform or enrich TAK messages
  transformers:
    # Example: FlightRadar24 aircraft data source
    - id: flightradar24-source
      path: "flightradar24_source.wasm"
      enabled: true
      config:
        description: "Import aircraft from FlightRadar24"
        # Center point for area of interest
        center_lat: 35.0
        center_lon: -79.0
        # Search radius in degrees
        radius_degrees: 2.0
        # Update interval in seconds
        update_interval_secs: 30
        # Convert to TAK friendly aircraft icons
        friendly_icon: true
        # Minimum altitude to include (feet)
        min_altitude_ft: 0
        # API credentials (use environment variables in production)
        # api_key: "${FR24_API_KEY}"

    # Example: Position enrichment
    - id: position-enricher
      path: "position_enricher.wasm"
      enabled: false
      config:
        description: "Enrich position data with terrain/elevation"
        # Add altitude above mean sea level
        add_altitude_msl: true
        # Add speed over ground
        add_speed: true
        # Add bearing/heading
        add_bearing: true
        # Terrain data source
        terrain_data_path: "./data/terrain"

    # Example: Geocoding transformer
    - id: geocoder
      path: "geocoder.wasm"
      enabled: false
      config:
        description: "Add place names to position reports"
        # Reverse geocode positions to addresses
        add_address: true
        # Add nearest city
        add_city: true
        # Cache size (number of entries)
        cache_size: 1000
        # Geocoding API endpoint
        # api_endpoint: "https://nominatim.openstreetmap.org"
